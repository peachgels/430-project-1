<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Tracker</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script>
    const handleResponse = async (response, parse) => {

      switch (response.status) {
        case 200: //success
          break;
        case 201: //created
          getDiary();
          break;
        case 204: //updated (no response back from server)
          return;
        case 400: //bad request
          break;
        case 404: //not found
          break;
        default: //any other status code
          break;
      }

      if (parse) {
        let obj = await response.json();
        populateDiary(response, obj);
      }
    };

    const populateDiary = (response, obj) => {
      const content = document.querySelector('#content');
      if (response.status === 200) {
        let diary = obj.films;
        console.log(diary);
        content.innerHTML = "";
        for (const f in diary) {
          const film = diary[f];
          //clear the current diary and repopulate
          // += for content (never replace, just add)
          const entry = document.createElement("div");
          entry.classList.add('entry');
          //create and add a custom class for diaryEntry (style in CSS as flexbox)
          if (film.poster) {
            if (film.review) {
              entry.innerHTML = `<div class="entry-inner"><div class="entry-front"><img src="${film.poster}" alt="Poster for ${film.name}"></div>
            <div class="entry-back">
              <div class="date">Watched On: ${film.date}</div>
              <div class="stars">${film.rating}/5</div>
              <div class="review">"${film.review}"</div>
            </div></div>`
            }
            else {
              entry.innerHTML = `<div class="entry-inner"><div class="entry-front"><img src="${film.poster}" alt="Poster for ${film.name}"></div>
            <div class="entry-back">
              <div class="date">Watched On: ${film.date}</div>
              <div class="stars">${film.rating}/5</div>
            </div></div>`
            }
          }
          else {
            if (film.review) {
              entry.innerHTML = `<div class="entry-inner"><div class="entry-front"><h2>${film.name}</h2></div>
            <div class="entry-back">
              <div class="date">Watched On: ${film.date}</div>
              <div class="stars">${film.rating}/5</div>
              <div class="review">"${film.review}"</div>
            </div></div>`
            }
            else {
              entry.innerHTML = `<div class="entry-inner"><div class="entry-front"><h2>${film.name}</h2></div>
            <div class="entry-back">
              <div class="date">Watched On: ${film.date}</div>
              <div class="stars">${film.rating}/5</div>
            </div></div>`
            }
          }
          //date watched (probably h2 and body text)
          //diary entry has film poster (if no poster provided, use name)
          //poster rollover text is film name
          //show rating
          //show review (if it exists)
          content.appendChild(entry);
        }
      }
    }

    const sendPost = async (diaryForm) => {

      const filmAction = diaryForm.getAttribute('action');
      const filmMethod = diaryForm.getAttribute('method');

      //Grab all the info from the form
      const nameField = diaryForm.querySelector('#nameField');
      const posterField = diaryForm.querySelector('#posterField');
      const dateField = diaryForm.querySelector('#dateField');
      const reviewField = diaryForm.querySelector('#reviewField');
      const ratingField = diaryForm.querySelector('#ratingField');

      //Build a data string in the FORM-URLENCODED format.
      const formData = `name=${nameField.value}&poster=${posterField.value}&date=${dateField.value}&review=${reviewField.value}&rating=${ratingField.value}`;

      let response = await fetch(filmAction, {
        method: filmMethod,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: formData,
      });

      handleResponse(response, true);
    };

    const getDiary = async () => {
      const method = "get";

      let response = await fetch("/getFilms", {
        method,
        headers: {
          'Accept': 'application/json'
        },
      });

      handleResponse(response, method === 'get');
    };

    const init = () => {

      const diaryForm = document.querySelector('#diaryForm');

      const addFilm = (e) => {
        e.preventDefault();
        sendPost(diaryForm);

        return false;
      }
      //make the buttons work
      diaryForm.addEventListener('submit', addFilm);

      //on refresh, keep stored items on page
      getDiary();
    };

    window.onload = init;

  </script>
</head>

<body>
  <section id="top">
    <h1>Movie Tracker</h1>
    <form id="diaryForm" autocomplete="off" action="/addFilm" method="post">
      <label for="name">Film Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="poster">Poster</label>
      <input id="posterField" type="url" pattern="https://.*" placeholder="https://example.PNG"
        value="https://i.etsystatic.com/18242346/r/il/c9908e/2412674268/il_fullxfull.2412674268_1sgm.jpg"
        posterLink="poster" />
      <label for="date">Date Watched: </label>
      <input id="dateField" type="date" name="date" />
      <label for="review">Review: </label>
      <input id="reviewField" type="text" name="review" />
      <label for="stars">Stars: </label>
      <input id="ratingField" type="number" name="rating" min="0" max="5" value="5" step="0.5" />
      <hr>
      <input type="submit" value="Log Film" />
    </form>
  </section>
  <section id="content">
  </section>
</body>

</html>